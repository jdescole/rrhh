<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link id="link1" rel="stylesheet" href="../Scripts/imgareaselect/imgareaselect-animated.css" type="text/css" />
    <style type="text/css">
        #pantalla_impresion_credencial
        {
        }      
         #pantalla_impresion_credencial #vista_previa_credencial
        {
            position: relative;
        }
        
         #pantalla_impresion_credencial #panel_derecho
        {
            position: absolute;
            right: 10px;
            left: 300px;
            top: 60px;
            bottom: 10px;
        }
        
        #pantalla_impresion_credencial #imagen_credencial
        {
            width: 250px;
        }        
        
        #pantalla_impresion_credencial #foto_usuario
        {
            position: absolute;
            top: 64px;
            left: 21px;
            height: 112px;
            width: 112px;
        }    
        
        #pantalla_impresion_credencial #apellido
        {
            position: absolute;
            top: 196px;
            left: 19px;
            font-size: 20px;
            color: white;
        }    
        
        #pantalla_impresion_credencial #nombres
        {
            position: absolute;
            top: 224px;
            left: 18px;
            font-size: 20px;
            color: white;
        }    
        
        #pantalla_impresion_credencial #btn_imprimir_credencial
        {

        }
        
        #pantalla_impresion_credencial #titulo_vista_previa
        {
            margin-top:0px;
        }
        
        #pantalla_impresion_credencial  #chk_credencial_impresa
        {
            /* Double-sized Checkboxes */
              -ms-transform: scale(2); /* IE */
              -moz-transform: scale(2); /* FF */
              -webkit-transform: scale(2); /* Safari and Chrome */
              -o-transform: scale(2); /* Opera */
                padding: 10px;
                margin-left: 27px;
                margin-right: 10px;
        }
        
        #pantalla_impresion_credencial  .checkboxtext
        {
            font-size: 110%;
            display: inline;
            vertical-align: middle;
        }
        
        #pantalla_impresion_credencial  #txt_codigo_magnetico
        {
            height: 30px;
            vertical-align: initial;
        }
        
        #pantalla_impresion_credencial #panel_dar_aviso
        {
            position: absolute;
            right: 10px;
            bottom: 10px;
            left: 0px;
        }
        #pantalla_impresion_credencial #txt_instrucciones_retiro
        {
            height: 30px;
            vertical-align: initial;            
            width: 100%;
            height: 100px;
        }
        
        #pantalla_impresion_credencial #btn_dar_aviso_y_cerrar
        {
            float: right;
        }
        
        @media print {
          body * {
            visibility: hidden;
          }
          #pantalla_impresion_credencial #vista_previa_credencial, 
          #pantalla_impresion_credencial #vista_previa_credencial * {
            visibility: visible;
          }
          #pantalla_impresion_credencial #vista_previa_credencial {
            position: absolute;
            left: 0;
            top: 0;
          }
        }
    </style>
</head>
<div id="pantalla_impresion_credencial">
    <h4 id="titulo_vista_previa">Vista Previa Credencial</h4>
    <div id="vista_previa_credencial">
        <img id="imagen_credencial" src="../BarraMenu/credencial.png"/>
        <div id="foto_usuario"></div>
        <div id="apellido"></div>    
        <div id="nombres"></div>    
    </div>
    <div id=panel_derecho>
        <input id="btn_imprimir_credencial" type="button" class="btn btn-info" value="Imprimir"/>        
        <input id="chk_credencial_impresa" type=checkbox />
        <span class="checkboxtext">
          Impresa
        </span>
        <div id="panel_codigo_magnetico" style="margin-top:30px;">
            <label>Código Magnético:</label>
            <input type=text id=txt_codigo_magnetico />
            <input id="btn_asociar_codigo_magnetico" type="button" class="btn btn-info" value="Asociar Código"/>     
        </div>
        <div id="panel_dar_aviso">
            <label style= "display: block;">Instrucciones para retirar Credencial</label>
            <textarea type=text id=txt_instrucciones_retiro></textarea>
            <input id="btn_dar_aviso_y_cerrar" type="button" class="btn btn-primary" value="Dar aviso y cerrar"/>     
        </div>
    </div>
</div>

<script type="text/javascript">
    var Componente = {
        start: function (ticket, ui) {
            ui.find("#panel_codigo_magnetico").hide();
            ui.find("#panel_dar_aviso").hide();
            Backend.GetSolicitudDeCredencialPorIdTicketImpresion(ticket.id).onSuccess(function (solicitud) {
                Backend.GetUsuarioPorIdPersona(solicitud.IdPersona).onSuccess(function (usuario) {
                    ui.find("#apellido").text(usuario.Owner.Apellido);
                    ui.find("#nombres").text(usuario.Owner.Nombre);
                    ui.find("#dni").text(usuario.Owner.Documento);

                    var img = new VistaThumbnail({
                        id: solicitud.Credencial.IdFoto,
                        contenedor: ui.find("#foto_usuario")
                    });

                    var btn_imprimir = ui.find("#btn_imprimir_credencial");
                    btn_imprimir.click(function () {
                        window.print();
                    });

                    var chk_impresa = ui.find("#chk_credencial_impresa");
                    if (solicitud.Credencial.Impresa) {
                        btn_imprimir.val("ReImprimir");
                        chk_impresa.attr("checked", true);
                        chk_impresa.attr("disabled", true);
                        ui.find("#panel_codigo_magnetico").show();
                    }
                    
                    chk_impresa.click(function () {
                        Backend.MarcarCredencialComoImpresa(solicitud.Credencial.Id)
                            .onSuccess(function () {
                                alertify.success("La credencial se marcó como impresa");
                                btn_imprimir.val("ReImprimir");
                                chk_impresa.attr("disabled", true);
                                ui.find("#panel_codigo_magnetico").show();
                                
                            })
                            .onError(function () {
                                alertify.error("Error");
                            });
                    });

                    var btn_asociar_codigo_magnetico = ui.find("#btn_asociar_codigo_magnetico");                    
                    if (solicitud.Credencial.CodigoMagnetico != "") {
                        btn_asociar_codigo_magnetico.val("ReAsociar");
                        ui.find("#panel_dar_aviso").show();
                    }
                    btn_asociar_codigo_magnetico.click(function () {
                        var codigo = ui.find("#txt_codigo_magnetico").val();
                        Backend.AsociarCodigoMagneticoACredencial(solicitud.Credencial.Id, codigo)
                            .onSuccess(function () {
                                alertify.success("el código magnético se asoció correctamente");
                                ui.find("#panel_dar_aviso").show();
                                
                            });
                        });
                
                    var btn_dar_aviso = ui.find("#btn_dar_aviso_y_cerrar");
                    btn_dar_aviso.click(function () {
                        var instrucciones = ui.find("#txt_instrucciones_retiro").val();
                        Backend.CerrarTicketImpresion(solicitud.Credencial.Id, instrucciones)
                            .onSuccess(function () {
                                alertify.success("Se envió un mensaje al usuario para que retire su credencial");
                                vex.close();
                                GestionDeTareas.getTareasParaGestion();
                            });

                    });
                });
            });
        }
    };
</script>
