<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<head>
    <style type="text/css">
        #pantalla_credencial_vigente
        {
             width: 250px;
             margin-top: 15px;
        }       
        #pantalla_credencial_vigente #credencial_vigente
        {
            position: relative;
        }
        
        #pantalla_credencial_vigente #imagen_credencial
        {
            width: 250px;
        }        
        
        #pantalla_credencial_vigente #foto_usuario
        {
            position: absolute;
            top: 61px;
            left: 15px;
            height: 126px;
            width: 126px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px white solid;
        }    
        
        #pantalla_credencial_vigente #codigo_barras
        {
            position: absolute;
            right: -4%;
            top: 25%;
            -ms-transform: rotate(90deg); /* IE 9 */
            -webkit-transform: rotate(90deg); /* Safari */
            transform: rotate(90deg); /* Standard syntax */
        }   
            
        #pantalla_credencial_vigente #apellido
        {
            position: absolute;
            top: 196px;
            left: 19px;
            font-size: 20px;
            color: white;
        }    
        
        #pantalla_credencial_vigente #nombres
        {
            position: absolute;
            top: 224px;
            left: 18px;
            font-size: 20px;
            color: white;
        }    
        
        #pantalla_credencial_vigente #documento
        {
            position: absolute;
            top: 252px;
            left: 66px;
            font-size: 20px;
            color: white;
        }    
            
        #pantalla_credencial_vigente #titulo_documento
        {
            position: absolute;
            top: 252px;
            left: 18px;
            font-size: 20px;
            color: white;
        }    
        
        #pantalla_credencial_vigente #btn_renovar_credencial
        {
            margin-top: 10px;
            display: inline-block;
            white-space: normal;
            width: 100%;
        }
        
        #pantalla_credencial_vigente #btn_renovar_credencial label
        {
            text-align: center;
            width: 100%;
            cursor: pointer;
            white-space: normal;
        }    
        
        #sin_credencial_vigente
        {
            text-align: center;
        }
    </style>
</head>
<div id=pantalla_credencial_vigente>
    <div id="credencial_vigente">
        <img id="imagen_credencial" src=""/>
        <div id="foto_usuario"></div>
        <div id="apellido"></div>    
        <div id="nombres"></div>    
        <div id="titulo_documento">DNI:</div>    
        <div id="documento"></div>    
        <div id="codigo_barras"></div>    
    </div>
    <div id="sin_credencial_vigente">
        No tiene una credencial vigente
    </div>
    <input type=button id=btn_renovar_credencial class= "btn btn-primary" value= "Solicitar Credencial"/>
</div>
<script type="text/javascript" src="../Scripts/jquery-barcode.js"/>
<script type="text/javascript">
    var Componente = {
        start: function (credencial, ui, usuario) {
            var _this = this;
            this.ui = ui;
            ui.find("#credencial_vigente").hide();
            ui.find("#sin_credencial_vigente").hide();

            vex.defaultOptions.className = 'vex-theme-os';
            vex.close();
            vex.open({
                afterOpen: function ($vexContent) {
                    //var ui = $("#plantillas_barra_menu #pantalla_credencial_vigente").clone();

                    if (!usuario) {
                        Backend.GetUsuarioLogueado().onSuccess(function (usuario_logueado) {
                            Backend.GetCredencialesTodasDePortal().onSuccess(function (credenciales) {
                                _this.cargarCredencial($vexContent, usuario_logueado, credenciales);
                            });
                        });
                    } else {
                        Backend.GetCredencialesDeUnaPersona(usuario.Owner.Id).onSuccess(function (credenciales) {
                            _this.cargarCredencial($vexContent, usuario, credenciales);
                        });
                    }
                    return ui;
                },
                css: {
                    'padding-top': "4%",
                    'padding-bottom': "0%"
                }
            });
        },
        cargarCredencial: function ($vexContent, usuario, credenciales) {
            var _this = this;
            var credencial_vigente = _.find(credenciales, function (c) { return c.Estado == "VIGENTE" });

            if (credencial_vigente) {
                this.ui.find("#credencial_vigente").show();
                this.ui.find("#apellido").text(usuario.Owner.Apellido);
                this.ui.find("#nombres").text(usuario.Owner.Nombre);
                this.ui.find("#documento").text(usuario.Owner.Documento);

                var src = "";
                if (credencial_vigente.Organismo == 'Ministerio de Desarrollo Social') {
                    if (credencial_vigente.Tipo == 'Definitiva') src = '../BarraMenu/credencialMDS.jpg';
                    if (credencial_vigente.Tipo == 'Externa') src = '../BarraMenu/credencialMDS_Externa.jpg';
                }
                if (credencial_vigente.Organismo == 'Ministerio de Salud') {
                    if (credencial_vigente.Tipo == 'Definitiva') src = '../BarraMenu/credencialMSAL.jpg';
                    if (credencial_vigente.Tipo == 'Externa') src = '../BarraMenu/credencialMSAL_Externa.jpg';
                }
                if (credencial_vigente.Organismo == 'Instituto Nacional de las Mujeres') {
                    if (credencial_vigente.Tipo == 'Definitiva') src = '../BarraMenu/credencialINM.jpg';
                    if (credencial_vigente.Tipo == 'Externa') src = '../BarraMenu/credencialINM_Externa.jpg';
                }

                this.ui.find("#imagen_credencial").attr('src', src);

                var img = new VistaThumbnail({
                    id: credencial_vigente.IdFoto,
                    contenedor: this.ui.find("#foto_usuario")
                });

                _this.ui.find("#codigo_barras").barcode(usuario.Owner.Documento.toString(), "code128", {
                    showHRI: false,
                    height: 10,
                    width: 180
                });
            } else {
                this.ui.find("#sin_credencial_vigente").show();
            }

            Backend.PuedePedirCredencial().onSuccess(function (respuesta) {
                if (respuesta != 'OK') {
                    _this.ui.find("#btn_renovar_credencial").attr('value', respuesta);
                    _this.ui.find("#btn_realizar_solicitud").prop('disabled', true);
                    return;
                }
                _this.ui.find("#btn_renovar_credencial").click(function () {
                    var div = $("<div>");
                    div.load(window.location.origin + '/Componentes/SolicitarRenovacionCredencial.htm', function () {
                        Componente.start({ usuario: usuario, credencial: credencial_vigente }, div);
                    });
                });
            });


            $vexContent.css("width", "280px");
            $vexContent.append(_this.ui);
            _this.ui.show();

        }
    };
</script>
