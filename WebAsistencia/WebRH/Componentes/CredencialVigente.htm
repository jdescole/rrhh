<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<head>
    <style type="text/css">
        #pantalla_credencial_vigente
        {
             width: 250px;
             margin-top: 15px;
        }       
        #pantalla_credencial_vigente #credencial_vigente
        {
            position: relative;
        }
        
        #pantalla_credencial_vigente #imagen_credencial
        {
            width: 250px;
        }        
        
        #pantalla_credencial_vigente #foto_usuario
        {
            position: absolute;
            top: 64px;
            left: 21px;
            height: 112px;
            width: 112px;
        }    
        
        #pantalla_credencial_vigente #apellido
        {
            position: absolute;
            top: 196px;
            left: 19px;
            font-size: 20px;
            color: white;
        }    
        
        #pantalla_credencial_vigente #nombres
        {
            position: absolute;
            top: 224px;
            left: 18px;
            font-size: 20px;
            color: white;
        }    
        #pantalla_credencial_vigente #btn_renovar_credencial
        {
            margin-top: 10px;
            display: inline-block;
        }
        
        #pantalla_credencial_vigente #btn_renovar_credencial label
        {
            text-align: center;
            width: 100%;
            cursor: pointer;
        }    
    </style>
</head>
<div id=pantalla_credencial_vigente>
    <div id="credencial_vigente">
        <img id="imagen_credencial" src="../BarraMenu/credencial.png"/>
        <div id="foto_usuario"></div>
        <div id="apellido"></div>    
        <div id="nombres"></div>    
       <!-- <a id="btn_renovar_credencial">
            <label>¿Pérdida, robo o deterioro?</label>
            <label>Solicitá una nueva credencial</label>
        </a>  -->
    </div>
    <div id="sin_credencial_vigente">
        <label>No posee una credencial vigente</label>
        <input type=button id="btn_solicitar_nueva_credencial" class="btn btn-primary" value="Solicitar una credencial"/> 
    </div>
</div>
<script type="text/javascript">
    var Componente = {
        start: function (credencial, ui) {
            ui.find("#credencial_vigente").hide();
            ui.find("#sin_credencial_vigente").hide();

            vex.defaultOptions.className = 'vex-theme-os';
            vex.close();
            vex.open({
                afterOpen: function ($vexContent) {
                    //var ui = $("#plantillas_barra_menu #pantalla_credencial_vigente").clone();

                    Backend.GetUsuarioLogueado().onSuccess(function (usuario) {
                        Backend.GetCredencialesTodasDePortal().onSuccess(function (credenciales) {
                            console.log(ui);
                            var credencial_vigente = _.find(credenciales, function (c) { return c.Estado == "VIGENTE" });
                            ui.find("#credencial_vigente").show();
                            ui.find("#apellido").text(usuario.Owner.Apellido);
                            ui.find("#nombres").text(usuario.Owner.Nombre);

//                            ui.find("#btn_renovar_credencial").click(function () {
//                                var div = $("<div>");
//                                div.load(window.location.origin + '/Componentes/SolicitarRenovacionCredencial.htm', function () {
//                                    Componente.start({credencial:credencial_vigente}, div);
//                                });
//                            });

                            
                            //
                            $('#btn_renovar_credencial').click(function () {


                                //var ui = $("#cajaCambiarDomicilio");

                                vex.defaultOptions.className = 'vex-theme-os';
                                vex.open({
                                    afterOpen: function ($vexContent) {
                                        var ui = $("#cajaCambiarDomicilio").clone();
                                        $vexContent.append(ui);
                                        ui.show();

                                        _this.getProvincias(ui);
                                        //primero CABA x default
                                        _this.getLocalidades(ui, 0);

                                        ui.find('#cmb_provincia').change(function () {
                                            ui.find("#cmb_localidad").empty();
                                            var idProvincia = parseInt(ui.find("#cmb_provincia option:selected").val());
                                            _this.getLocalidades(ui, idProvincia);
                                        });

                                        ui.find('#btnCambiarDomicilio').click(function () {

                                            if (ui.find('#txt_calle').val() == '' || ui.find('#txt_numero').val() == '' || ui.find('#txt_cp').val() == '') {
                                                alert('Debe completar los campos obligatorios');
                                                return;
                                            }

                                            var domicilio = {};
                                            domicilio.Calle = ui.find('#txt_calle').val();
                                            domicilio.Numero = ui.find('#txt_numero').val();
                                            domicilio.Piso = ui.find('#txt_piso').val();
                                            domicilio.Depto = ui.find('#txt_dto').val();
                                            domicilio.Cp = ui.find('#txt_cp').val();
                                            domicilio.Localidad = ui.find('#cmb_localidad').val();
                                            domicilio.Provincia = ui.find('#cmb_provincia').val();
                                            domicilio.Manzana = ui.find('#txt_manzana').val();
                                            domicilio.Casa = ui.find('#txt_casa').val();
                                            domicilio.Barrio = ui.find('#cmb_barrio').val();
                                            domicilio.Torre = ui.find('#cmb_torre').val();
                                            domicilio.Uf = ui.find('#cmb_uf').val();
                                            Backend.GuardarDomicilioPendiente(domicilio)
                                    .onSuccess(function (respuesta) {

                                        alertify.success("Solicitud creada.");
                                        //vex.dialog.alert('Solicitud de cambio de domicilio generada. Presente el formulario impreso a RRHH');
                                        _this.getDatosPersonales();
                                        vex.close();


                                    })
                                    .onError(function (e) {

                                    });
                                        });

                                        return ui;
                                    },
                                    css: {
                                        'padding-top': "4%",
                                        'padding-bottom': "0%"
                                    },
                                    contentCSS: {
                                        width: "50%",
                                        height: "330px"
                                    }
                                });
                                //$('#cajaCambiarDomicilio').show();
                            });



                            //


                            var img = new VistaThumbnail({
                                id: credencial_vigente.IdFoto,
                                contenedor: ui.find("#foto_usuario")
                            });
                            $vexContent.css("width", "280px");
                            $vexContent.append(ui);
                            ui.show();
                        });
                    });
                    return ui;
                },
                css: {
                    'padding-top': "4%",
                    'padding-bottom': "0%"
                }
            });
        }
    };
</script>
